<!DOCTYPE html>
<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" >
<head>
  <title>KHEM</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <link type="text/css" rel="stylesheet" href="common/css/site.css"/>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/dojo/1.11.2/dojo/dojo.js"></script>

    <script type="text/javascript" src='Scilligence.JSDraw2.Pro.js'></script>
    <script type="text/javascript" src='Scilligence.JSDraw2.Resources.js'></script>
     <script type="text/javascript">
     function findMolecules()
		{
			clear();
			var searchCriteria = getSearchCriteria();
			
			if(searchCriteria == null)
			{
				showError("Select criteria (ex: By SMILES)");
				return false;
			}
			
			 var jsdraw = JSDraw.get("test");
			  var molStringFile = jsdraw.getMolfile();
			  var smiles = jsdraw.getSmiles();
			  var formula  = jsdraw.getFormula(true);
		      var weight = jsdraw.getMolWeight();
		      var source = document.getElementById("source").value;
		      var name = document.getElementById("moleculeName").value;
		      
			  if(searchCriteria == "BySourceAndName")
			  {
				  if(source == null || source.length == 0)
				  {
					  return showRequired("Source");
				  }
				  
				  if(name == null || name.length == 0)
				  {
					  return showRequired("Name");
				  }
			  }
		      else if(smiles == null || smiles.length == 0)
			  {
			      return showRequired("Drawn valid molecule in editor. For example, try benzene.");
			  }
						
			document.getElementById("moleculesPanel").innerHTML = "<img src='common/images/progress.gif'/>";
			currentSelectedRow = 0;
			
			var xhttp = new XMLHttpRequest();
			  xhttp.open("POST", "findMolecules",  true);
			  xhttp.setRequestHeader("Content-Type", "application/json");
			  
			  var khemCriteria = {
					  "structureCriteria" : {
						  "molString" : molStringFile,
						  "weight" : weight,
						  "formula" : formula,
						  "searchType": searchCriteria,
						  "smiles" : smiles,
			  			  "source": source,
			  			  "name": name
						  }
			  };
			  
			  var json = JSON.stringify(khemCriteria);
			  
			  //Response handler
			   xhttp.onreadystatechange = function() {
			        if (this.readyState == 4 && this.status == 200) 
			        {
			        	//Handle not records found
			        	if(this.responseText == null || this.responseText.length == 0)
			        	{
			        		document.getElementById("moleculesPanel").innerHTML = "No data found";
			        		return;
			        	}
			        	
			        	parent.moleculeArray =  JSON.parse(this.responseText);
			        	var tableHtml = "";
			        	
			        	var rowClass = "odd";
			        	
			        	//loop thru molecules
			        	for (i = 0; i < parent.moleculeArray.length; i++) {
			        		
			        		if(i % 2 == 0)
			        			rowClass =  "even";
			        		else
			        			rowClass =  "odd";
			        		
			        		tableHtml += "<tr class="+rowClass+" id=moleRow"+i+" onclick='viewMolecule("+i+")'>"+
			        			    "<td>"+parent.moleculeArray[i].sourceCode+"</td>"+
			        			    "<td>"+parent.moleculeArray[i].name+"</td>"+
			        				"<td>"+parent.moleculeArray[i].formula+"</td>"+
			        				"<td>"+parent.moleculeArray[i].weight+"</td>"
			        				;
			        		
			        		//add mol file
			        		tableHtml += "</tr>";
			        	}
			        	 
			        	tableHtml = "<table class=\"resultTable\">"+
			        	"<thead><tr><th>source</th><th>name</th><th>formula</th><th>weight</th></tr></thread>"+
				        	"<tbody>"+
				        		tableHtml+
				        	"</tbody>"+
			        	"</table>";
			        	
			         document.getElementById("moleculesPanel").innerHTML =tableHtml;

			       }//end of if
			       else if (this.readyState == 4 && this.status != 200) 
			       { 
			    	   //display error
			    	   var errorText  = "<div style='color:red'>"+this.responseText+"</div>";
			    	   document.getElementById("moleculesPanel").innerHTML = errorText;
			       }
			  };
			  
			  xhttp.send(json);
			
			return 0;
		}//----------------------------------------------------------
		function copyViewerToEditor()
		{
			JSDraw.get("test").setHtml(JSDraw.get("div1").getHtml());
			
			 document.getElementById("source").value = moleculeArray[currentSelectedRow].sourceCode;
		     document.getElementById("moleculeName").value = moleculeArray[currentSelectedRow].name;
		}
     </script>
  </head>
<body>

<!-- LOGO -->
<img src="common/images/pivotal.png"/> <img src="common/images/logo.png"/>
<br/>
<br/>
<div>
<form name="searchCriterForm" onsubmit="return false;">
  <input type="radio" name="how" value="BySMILES" checked="checked"> By SMILE 
  <input type="radio" name="how" value="ByWEIGHT"> By Weight
  <input type="radio" name="how" value="ByFORMULA"> By Formula
  <input type="radio" name="how" value="BySourceAndName"> By Source and Name 
  <button onclick="findMolecules()">Find</button>
</form>
<br/>
<!--  -->
<table>
	<tr>
		<td>Source:</td><td><input id="source" type="text" name="source"></input></td>
		<td>&nbsp;</td>
		<td>Name:</td><td><input id="moleculeName" type="text" name="moleculeName"></input></td>
	</tr>
	<tr>
		<td colspan="5"><div id="requiredPanel"></div></td>
	</tr>
</table>
	 

<table border=1><tr><td>
Editor:<br />
<div class='JSDraw' id="test" skin="w8" style="width: 660px; height: 300px;border:1px solid gray" ondatachange='molchange'
    dataformat='molfile'></div>
</td>
</tr></table>

<!-- ============================== -->
<!--  Molecule viewer -->
<div class='JSDraw' id="div1" style="z-index:10; position: fixed;left:710px; top:100px;width: 330px; height: 330px;border:1px solid gray" viewonly popup dataformat='molfile' data=''></div>
<!-- ============================== -->
<p><button onclick="saveMolecule();">&nbsp;Save&nbsp;</button></p>
<!-- ============================== -->
<button onclick='alert(JSDraw.get("test").getMolfile())'>Get Molfile</button>
<button onclick='alert(JSDraw.get("test").getRxnfile())'>Get Rxnfile</button>
<button onclick='alert(JSDraw.get("test").getSmiles())'>Get Smiles</button>
<!-- <button onclick='alert(JSDraw.get("test").getHtml())'>Get Html</button> -->
<button onclick='copyViewerToEditor()'>Copy Viewer to Editor</button>
<!-- <button onclick='JSDraw.get("test").sss(JSDraw.get("div1"))'>View Substructure</button> -->
<br />

<p>
Mol. Weight: <span id='mw' style='width:120px;font-weight:bold'></span> Formula: <span id='formula' style='width:300px;font-weight:bold'></span>
</p>
<script type="text/javascript">
    JSDraw.init();
    
    function molchange(jsdraw) {
        document.getElementById('formula').innerHTML = jsdraw.getFormula(true);
        document.getElementById('mw').innerHTML = jsdraw.getMolWeight();
    }//---------------------------------------
    function getSearchCriteria (radios)
    {
    	var howRadios = document.forms["searchCriterForm"]["how"];
    	
        for (i = 0; i < howRadios.length; ++ i)
        {
            if(howRadios [i].checked)
            	return howRadios [i].value;
        }
        return null;
    }
    
</script>

</div>

<br/>
<div id="moleculesPanel">

</div>

<script type="text/javascript">
    JSDraw.init();
    
	var moleculeArray = [{}];
	var currentSelectedRow = 0;
	
    function molchange(jsdraw) {
        document.getElementById('formula').innerHTML = jsdraw.getFormula(true);
        document.getElementById('mw').innerHTML = jsdraw.getMolWeight();
    }//-----------------------------------------
    function viewMolecule(i)
    {
    		//alert(moleculeArray[i].molString);
    		var previousRow = document.getElementById('moleRow'+currentSelectedRow);
    		
    		if(currentSelectedRow % 2 == 1)
    			previousRow.className = 'odd';
    		else
    			previousRow.className = 'even';
    			
    		var row = document.getElementById('moleRow'+i);
    		
    		row.className = "select";

    		JSDraw.get("div1").setMolfile(moleculeArray[i].molString);
    		
    		currentSelectedRow = i;

    }//---------------------------------------------------------------------
    function showError(errorText)
    {
       	 var redText  = "";
    	 
    	 if(errorText.length > 0)
    	 {
    	   	 redText = "<div style='color:red'>"+errorText+"</div>";
    	 }
  	   
    	 document.getElementById("moleculesPanel").innerHTML = redText;
    	
    }//---------------------------------------------------------------------
    function showGood(msg)
    {
    	
    	 var text  = "<div style='color:green'>"+msg+"</div>";
  	   
  	     document.getElementById("moleculesPanel").innerHTML = text;
    	
    }//---------------------------------------------------------------------
    function showRequired(msg)
    {
    	var text  = "";
    	
    	if(msg.length > 0)
    	{
    	   	text = "<div style='color:red'>"+msg+" is required</div>";
    	}
   	   
 	    document.getElementById("requiredPanel").innerHTML = text;
    }
    </script>

	<script  type="text/javascript">
		function clear()
		{
			  showRequired("");
			  showError("");
		}//----------------------------------------------------------
		/**
		 * Save the molecule
		 */
		function saveMolecule()
		{		
			
			  clear();
			  var source = document.getElementById("source").value;
			  if(source == null || source.length == 0)
			  {
				  return showRequired("Source");
			  }
			  
			  var name = document.getElementById("moleculeName").value;
			  if(name == null || name.length == 0)
			  {
				  return showRequired("Name");
			  }
			
			   var jsdraw = JSDraw.get("test");
			   var molStringFile = jsdraw.getMolfile();
			   var name =  document.getElementById("moleculeName").value;
			   var smiles = jsdraw.getSmiles();
			   if(smiles == null || smiles.length == 0)
			   {
					  return showRequired("Least one valid drawn molecule in editor");
			   }
			   
			   //create molecule object
			   var molecule = {
					   canonicalSMILES : smiles,
					   sourceCode : source,
					   formula : jsdraw.getFormula(true),
					   molKey : smiles,
					   molString : molStringFile,
					   name : name,
					   weight : jsdraw.getMolWeight()
			   }
   
				var xhttp = new XMLHttpRequest();
				  xhttp.open("POST", "saveMolecule",  true);
				  xhttp.setRequestHeader("Content-Type", "application/json");
				  xhttp.onreadystatechange = function() {
				        if (this.readyState == 4 && this.status == 200) 
				        {
				        	showGood("Saved");
				        }
				        else if (this.readyState == 4 && this.status != 200) 
					    {
					    	   showError(this.responseText);
					    }					    
				  };
				  
				  var json = JSON.stringify(molecule);
				  //alert("json:"+json);
				  
				  xhttp.send(json);
		    }//---------------------------------------------------------------------

	</script>
</body>


</html>