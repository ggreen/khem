<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:aop="http://www.springframework.org/schema/aop" 
	xmlns:p="http://www.springframework.org/schema/p"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd
		http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch-2.1.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

<!-- *********************** PTG JOB ************************************-->
	<job id="CHEMICAL_ANNOTATIONS_PTG" xmlns="http://www.springframework.org/schema/batch">
		<step id="CHEMICAL_ANNOTATIONS_PTG_IMPORT" next="CHEMISTRY_ANNOT_KEYS_PTG_IMPORT">
			<tasklet>
				<chunk reader="CHEMISTRY_ANNOTATIONS_PTG_READER" writer="CHEMISTRY_ANNOTATIONS_SSS_WRITER"
					commit-interval="50000"/>
				<listeners>
		            <listener ref="CHEMISTRY_ANNOTATIONS_PTG_PREPROCESSOR"/>
					 <listener ref="BATCH_ERROR_LISTENER"/>
		        </listeners>
			</tasklet>
		</step>
		<split id="CHEMISTRY_ANNOT_KEYS_PTG_IMPORT">
		    <flow>
				<step id="CHEMISTRY_ANNOT_KEYS_PTG_ACD_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_PTG_ACD_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>
			</flow>
			<flow>
				<step id="CHEMISTRY_ANNOT_KEYS_PTG_MCIDB_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_PTG_MCIDB_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>
			</flow>
			<flow>	
				<step id="CHEMISTRY_ANNOT_KEYS_PTG_MERCKACD_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_PTG_MERCKACD_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>	
			</flow>
		</split>
	</job>
<!-- *********************** SLT JOB ************************************-->	
    <job id="CHEMICAL_ANNOTATIONS_SLT" xmlns="http://www.springframework.org/schema/batch">
		<step id="CHEMICAL_ANNOTATIONS_SLT_IMPORT" next="CHEMISTRY_ANNOT_KEYS_SLT_IMPORT">
			<tasklet>
				<chunk reader="CHEMISTRY_ANNOTATIONS_SLT_READER" writer="CHEMISTRY_ANNOTATIONS_SLT_WRITER"
					commit-interval="50000"/>
				<listeners>
		            <listener ref="CHEMISTRY_ANNOTATIONS_SLT_PREPROCESSOR"/>
					 <listener ref="BATCH_ERROR_LISTENER"/>
		        </listeners>
			</tasklet>
		</step>
		<split id="CHEMISTRY_ANNOT_KEYS_SLT_IMPORT">
		    <flow>
				<step id="CHEMISTRY_ANNOT_KEYS_SLT_ACD_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_SLT_ACD_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>
			</flow>
			<flow>
				<step id="CHEMISTRY_ANNOT_KEYS_SLT_MCIDB_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_SLT_MCIDB_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>
			</flow>
			<flow>	
				<step id="CHEMISTRY_ANNOT_SLT_KEYS_MERCKACD_IMPORT">
					<tasklet>
						<chunk reader="CHEMISTRY_ANNOT_KEYS_SLT_MERCKACD_IMPORT_READER" writer="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER"
							commit-interval="50000" />
					</tasklet>
				</step>	
			</flow>
		</split>
	</job>	
  <!--   ************  PTG CHEMISTRY_ANNOT_KEYS *******************************-->
  <bean id="CHEMISTRY_ANNOT_KEYS_PTG_ACD_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_ptg.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , MDLNUMBER,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'ACD' from molacd.acd2d_moltable where sss(CTAB, ?)=1
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="acdDataSource"/>
	</bean>
	<bean id="CHEMISTRY_ANNOT_KEYS_PTG_MCIDB_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_ptg.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , COMPOUND_ID,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'MCIDB' from ecdspic60.rcg_stuff_moltable 
			where sss(CTAB, ?)=1 and COMPOUND_ID is not null
			and COMPOUND_ID in
				(select LNUM
				 from ECDSDAT.INV_CMPD_SAMPLES INV 
				where  INV.AMOUNT > 0.1 
					and UPPER(INV.UNITS) = 'G')
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="mcidbDataSource"/>
	</bean>	
    <bean id="CHEMISTRY_ANNOT_KEYS_PTG_MERCKACD_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_ptg.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , MDLNUMBER,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'MERCKACD' from ecdsermstruct60.MRK_ACD2D_MOL 
			where sss(CTAB, ?)=1
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="merckAcdDataSource"/>
	</bean>		
	
	<bean id="CHEMISTRY_ANNOTATIONS_PTG_READER" class="com.merck.mrl.asap.integration.batch.FileSdfReader">
		<property name="filePath" value="runtime/input/chem_annotations_ptg.sdf"/>
	</bean>  
	  <!--   ************  SLT CHEMISTRY_ANNOTATIONS *******************************-->
	<bean id="CHEMISTRY_ANNOT_KEYS_SLT_ACD_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_slt.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , MDLNUMBER,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'ACD' 
			from molacd.acd2d_moltable 
			where flexmatch(CTAB, ?, 'ignore=sal,tau,cha,fra,hyd,ion' ) = 1 
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="acdDataSource"/>
	</bean>
	<bean id="CHEMISTRY_ANNOT_KEYS_SLT_MCIDB_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_slt.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , COMPOUND_ID,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'MCIDB' from ecdspic60.rcg_stuff_moltable 
			where COMPOUND_ID is not null and flexmatch(CTAB, ?, 'ignore=sal,tau,cha,fra,hyd,ion' ) = 1 
			and COMPOUND_ID in
				(select LNUM
				 from ECDSDAT.INV_CMPD_SAMPLES INV 
				where  INV.AMOUNT > 0.1 
					and UPPER(INV.UNITS) = 'G')
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="mcidbDataSource"/>
	</bean>	
    <bean id="CHEMISTRY_ANNOT_KEYS_SLT_MERCKACD_IMPORT_READER" class="com.merck.mrl.asap.integration.batch.DataRowSqlSdfMolInputReader">
		<property name="filePath" value="runtime/input/chem_annotations_slt.sdf"/>
		<property name="sql">
			<value>
			select /*+ FIRST_ROWS */ molnemakey(ctab) as MOLKEY , MDLNUMBER,  ? as ANNOATION_NM, ? as CHEM_ANNOTATION_CD , 'MERCKACD' from ecdsermstruct60.MRK_ACD2D_MOL 
			where  flexmatch(CTAB, ?, 'ignore=sal,tau,cha,fra,hyd,ion' ) = 1 
			</value>
		</property>
		<property name="paramXIndex" value="1"/>
		<property name="paramXName" value="NAME"/>
		
		<property name="paramYIndex" value="2"/>
		<property name="paramYName" value="CHEM_ANNOTATION_CD"/>
		
		<property name="molIndex" value="3"/>
		
		<property name="dataSource" ref="merckAcdDataSource"/>
	</bean>		
	<bean id="CHEMISTRY_ANNOTATIONS_SLT_READER" class="com.merck.mrl.asap.integration.batch.FileSdfReader">
		<property name="filePath" value="runtime/input/chem_annotations_slt.sdf"/>
	</bean> 
	
	<!--   *******************************************-->
	
<bean id="CHEMISTRY_ANNOT_KEYS_IMPORT_WRITER" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
		<property name="sql">
			<value>INSERT
					INTO CHEM_ANNOT_STRUCT_KEYS
					  (
					    MOLKEY,
					    STRUCTUREKEY,
					    ANNOTATION_NM,
					    CHEM_ANNOTATION_CD,
					    STRUCT_SOURCE_CD
					  )
					  VALUES
					  (
					    ?,
					    ?,
					    ?,
					    ?,
					    ?
					  )
			</value>
		</property>
				<property name="dataSource">
			<ref bean="dataSource"/>
		</property>
		<property name="itemPreparedStatementSetter">
			<ref bean="itemPreparedStatementSetter"/>
		</property>
	</bean>	
	<bean id="CHEMISTRY_ANNOTATIONS_SSS_WRITER" class="com.merck.mrl.asap.integration.batch.ChemicalAnnotationWriter">
		<property name="annotationNameParamName" value="NAME"/>
		<property name="codeParamName" value="CHEM_ANNOTATION_CD"/>
		<property name="operationParamName" value="OPERATION"/>
		<property name="defaultOperation" value="SSS"/>
		<property name="dataSource"><ref bean="dataSource"/></property>
		<property name="saveKeys" value="false"/>
		<property name="deletePreviousAnnotationKeys" value="false"/>
		<property name="compoundService"><ref bean="compoundService"/></property>
	</bean>
	<bean id="CHEMISTRY_ANNOTATIONS_SLT_WRITER" class="com.merck.mrl.asap.integration.batch.ChemicalAnnotationWriter">
		<property name="annotationNameParamName" value="NAME"/>
		<property name="codeParamName" value="CHEM_ANNOTATION_CD"/>
		<property name="operationParamName" value="OPERATION"/>
		<property name="defaultOperation" value="FLEXMATCH_SALT"/>
		<property name="dataSource"><ref bean="dataSource"/></property>
		<property name="saveKeys" value="false"/>
		<property name="deletePreviousAnnotationKeys" value="false"/>
		<property name="compoundService"><ref bean="compoundService"/></property>
	</bean>	
	
	<!-- ******************** PREPROCESSOR ********************************************* -->
	 <bean id="CHEMISTRY_ANNOTATIONS_PTG_PREPROCESSOR" class="solutions.dao.spring.batch.CommandStepExecutionListener">
		<property name="beforeCommand">
			<bean class="solutions.dao.executable.BatchSqlExecutable">
				<property name="sqls">
				     <list>
					  <value><![CDATA[delete from CHEM_ANNOT_STRUCT_KEYS where CHEM_ANNOTATION_CD = 'PTG']]></value> 
				      <value><![CDATA[delete from CHEM_ANNOTATIONS where CHEM_ANNOTATION_CD = 'PTG']]></value> 
				      </list>
				</property>
				<property name="dataSource" ref="dataSource"/>
			</bean>
		</property>
	</bean>
	 <bean id="CHEMISTRY_ANNOTATIONS_SLT_PREPROCESSOR" class="solutions.dao.spring.batch.CommandStepExecutionListener">
		<property name="beforeCommand">
			<bean class="solutions.dao.executable.BatchSqlExecutable">
				<property name="sqls">
				     <list>
					  <value><![CDATA[delete from CHEM_ANNOT_STRUCT_KEYS where CHEM_ANNOTATION_CD = 'SLT']]></value> 
				      <value><![CDATA[delete from CHEM_ANNOTATIONS where CHEM_ANNOTATION_CD = 'SLT']]></value> 
				      </list>
				</property>
				<property name="dataSource" ref="dataSource"/>
			</bean>
		</property>
	</bean>
</beans>